services:
  backup:
    image: mazzolino/restic
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    container_name: ${CONTAINER_NAME}_restic__backup
    restart: unless-stopped
    environment:
      RUN_ON_STARTUP: "false"
      BACKUP_CRON: "0 30 3 * * *"
      TZ: ${TZ:-Europe/Moscow}
      # docker control
      PRE_COMMANDS: |-
        docker stop ${CONTAINER_NAME}_main
      POST_COMMANDS_SUCCESS: |-
        docker start ${CONTAINER_NAME}_main
      # restic settings
      RESTIC_COMPRESSION: auto
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:-123}
      RESTIC_REPOSITORY: /mnt/restic
      RESTIC_BACKUP_ARGS: >-
        --tag docker-${CONTAINER_NAME}
        --skip-if-unchanged
        --verbose
      RESTIC_FORGET_ARGS: >-
        --keep-last 10
        --keep-daily 7
        --keep-weekly 5
        --keep-monthly 12
      # beckaup forlder in conteiner
      RESTIC_BACKUP_SOURCES: /backup_data

    volumes:
      - ./${CONTAINER_NAME}_data/config:/backup_data:ro
      - ./${CONTAINER_NAME}_data/backup_restore:/restore_data
      - /backup/ssd/restic/${CONTAINER_NAME}_backups:/mnt/restic
      - /var/run/docker.sock:/var/run/docker.sock:ro

  prune:
    image: mazzolino/restic
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    container_name: ${CONTAINER_NAME}_restic__prune
    restart: unless-stopped
    environment:
      SKIP_INIT: "true"
      RUN_ON_STARTUP: "false"
      PRUNE_CRON: "0 0 4 * * *"
      TZ: ${TZ:-Europe/Moscow}
      # restic settings
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:-123}
      RESTIC_REPOSITORY: /mnt/restic
      RESTIC_PRUNE_ARGS: >
        --verbose
    volumes:
      - /backup/ssd/restic/${CONTAINER_NAME}_backups:/mnt/restic

  check:
    image: mazzolino/restic
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    container_name: ${CONTAINER_NAME}_restic__check
    restart: unless-stopped
    environment:
      SKIP_INIT: "true"
      RUN_ON_STARTUP: "false"
      CHECK_CRON: "0 15 5 * * *"
      TZ: ${TZ:-Europe/Moscow}
      # restic settings
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:-123}
      RESTIC_REPOSITORY: /mnt/restic
      RESTIC_CHECK_ARGS: >-
        --read-data-subset=10%
        --verbose
    volumes:
      - /backup/ssd/restic/${CONTAINER_NAME}_backups:/mnt/restic
