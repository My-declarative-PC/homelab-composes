services:
  traefik:
    image: traefik:v3
    container_name: ${CONTAINER_NAME}_main
    labels:
      # watchtower
      com.centurylinklabs.watchtower.enable: true
      # traefik
      traefik.enable: "true"
      traefik.http.routers.dashboard.rule: Host(`traefik.${DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))
      traefik.http.routers.dashboard.entrypoints: "websecure"
      traefik.http.routers.dashboard.tls.certresolver: "letsencrypt"
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.middlewares: auth
      traefik.http.middlewares.auth.basicauth.users: ${TRAEFIK_USER}:${TRAEFIK_PASSWORD_HASH}
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      CF_DNS_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
    networks:
      - traefik
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./${CONTAINER_NAME}_data/acme.json:/acme/acme.json
  # 
  # BeckUps
  # 
  ## main
  backup_restic__traefik:
    extends:
      file: ../restic/restic-compose-base.yaml
      service: backup
    volumes:
      - ./${CONTAINER_NAME}_data/config:/backup_data:ro
  ## prune
  prune_restic__traefik:
    extends:
      file: ../restic/restic-compose-base.yaml
      service: prune
  ## chekc
  check_restic__traefik:
    extends:
      file: ../restic/restic-compose-base.yaml
      service: check
#
# NetWorks
#
networks:
  traefik:
    external: true
  apprise_notification: 
    external: true
